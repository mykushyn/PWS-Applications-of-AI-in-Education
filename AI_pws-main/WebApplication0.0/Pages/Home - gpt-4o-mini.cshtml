@page
@model IndexModel
@{
   ViewData["Title"] = "Home page";
}

<h1>@ViewData["Title"]</h1>

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
</div>

<input type="text" id="messageInput" placeholder="Type your message" />
<button onclick="sendMessage()">Send</button>
<button onclick="startRecording()">Mic</button>

<div id="chatBox"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    connection.on("ReceiveMessage", (user, message) => {
        console.log("ReceiveMessage:", user, message);
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML += `<p><b>${user}:</b> ${message}</p>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    connection.on("ReceiveAudio", (user, audioBytes) => {
        console.log("ReceiveAudio called! User:", user, "Audio data:", typeof audioBytes, audioBytes?.length);
        try {
            // SignalR sends bytes as base64 string, need to convert
            let byteArray;
            if (typeof audioBytes === 'string') {
                // It's base64, decode it
                const binaryString = atob(audioBytes);
                byteArray = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    byteArray[i] = binaryString.charCodeAt(i);
                }
            } else {
                byteArray = new Uint8Array(audioBytes);
            }

            const blob = new Blob([byteArray], { type: 'audio/mpeg' });
            console.log("Blob created, size:", blob.size);
            const url = URL.createObjectURL(blob);
            console.log("Audio URL:", url);
            const audio = new Audio(url);
            audio.play().then(() => {
                console.log("Audio playing!");
            }).catch(err => {
                console.error("Audio play error:", err);
            });
            // Clean up URL after playing
            audio.onended = () => {
                console.log("Audio ended");
                URL.revokeObjectURL(url);
            };
        } catch (error) {
            console.error("ReceiveAudio error:", error);
        }
    });

    connection.start().then(() => {
        console.log("Connected to ChatHub");
    }).catch(err => console.error("Connection error:", err));

    function sendMessage() {
        const message = document.getElementById("messageInput").value;
        if (message.trim()) {
            console.log("Sending message:", message);
            connection.invoke("SendMessage", "User", message);
            document.getElementById("messageInput").value = '';
        }
    }

    // Audio input using Web Speech API
    function startRecording() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            connection.invoke("SendMessage", "User", transcript);
        };
        recognition.onerror = function(event) {
            console.error("Speech recognition error:", event.error);
        };
        recognition.start();
    }
</script>

